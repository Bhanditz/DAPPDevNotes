# 以iBank为例，浅谈EOS DApp合约的安全设计

EOS主网上线以来，DApp合约的安全问题一直为大家所诟病，层出不穷的DApp合约安全问题，也确实让用户很难对EOS生态内的DApp安全放心。DappPub社区自成立以来已经开发了10余款Dapp，在DApp安全方面也算有些经验，今天就以iBank的DApp合约结构设计为例，分享一下我们对DApp合约安全的一些看法。

### 分而治之

影响一个DApp最终是否安全的因素非常多，首先任何一个DApp都分成链上和链下两部分。DApp的链下部分主要包括其前端和一些链上无法直接提供的后端数据接口，这部分跟传统的互联网安全更加接近，今天的文章里就不再赘述。而我们今天主要介绍的就是链上DApp合约的安全设计。

以iBank为例，我们将整个DApp以业务为界拆分成三个部分：储蓄产品、资金管理和资源租赁。然后，我们针对这三部分业务拆分出三个合约，分别进行相关业务的处理。储蓄产品由bankcoinfund进行处理，资金管理由bankreserves合约进行，资源租赁则由cpubankstake来进行处理。整体架构如下：

![iBank-Arch](https://raw.githubusercontent.com/Dappub/DAPPDevNotes/master/img/iBank-Arch.png)

大家可能要问，为什么要舍近求远，把本来一个合约就可以做掉的事情分成三个合约？其实之所以这么设计不是我们没事情给自己找事情做，根本原因就是为了保障整个DApp的安全。经过这样子的拆分后，各合约相互之间解耦，各自的逻辑更加聚焦，也就更不容易出现因逻辑漏洞而被攻击。最后也因为进行了合约拆分，各自的业务特点所遇到的安全问题都可以得到最大化的解决。

### 各个击破

合约进行拆分后，每个合约本身依然存在一些安全风险。但是得益于对合约进行了合理的拆分，我们可以对合约各自的安全问题进行有针对性的防范和处理。

#### 储蓄合约

![iBank-Arch](https://raw.githubusercontent.com/Dappub/DAPPDevNotes/master/img/Deposit.png)

储蓄合约在整个DApp中主要负责用户资金转入、转出以及利润的分配问题。这中间最重要的就是转入过程中，可能出现的假币、假通知等攻击方式对平台造成的损失。针对此类问题，我们完整的调研了整个EOS的转账机制，并针对转账过程中可能存在的所有风险点进行了预防和处理。

首先是假币攻击：假币攻击主要指的是用户转账时转入的币与EOS同名，但其合约地址并不是eosio.token。这时候只需要在合约的apply函数中进行检查，只有其合约为eosio.token的transfer行为才执行储蓄逻辑。

然后是假通知攻击：假通知攻击指的是用户利用对自己合约账户转账时进行定向通知，把自己两个账户间的转账行为通知给第三方合约进行攻击。这里需要注意的就是在执行实际的储蓄逻辑前，需要检查转入账号是否为本合约，如果不是本合约就表示当前请求是在被攻击者攻击。

而用户转出的过程中，则比较容易出现越权赎回和溢出攻击等问题。针对越权攻击，合约开发的时候要注意特定的行为一定要检查用户是否拥有相应的权限进行该操作。而溢出攻击则需要开发者注意在数值计算后对数值的上下限做好断言保证计算后得到的数值符合预期。

#### 资金管理合约

资金管理合约主要负责资金的分配和管理，而资金安全则是整个DApp安全的重中之重。因为大部分资金都在这组账号里，所以我们为了充分的保证资金安全，已经与钱包以及节点一起对该账号做了多签管理，并会在接下来的时间里引入更多的钱包和节点。而对该资金池账户的任何操作都需要其他多签的人一起确认才可以触发，这就保证了该账号资金不会因为某一方的私钥被盗而丢失。

同时资金管理合约中对外只提供一个租赁接口，该接口可以给指定的账号抵押资源，但抵押时EOS的所有权依然在资金池账号的管理下，永远不会出现EOS丢失的情况。

所以，通过对资金管理合约的多签和接口权限控制，保障了储户的资金不会发生丢失。而除非节点和钱包与我一起同谋，否则我们也没法拿到账号权限进行转账跑路。同时规避了资金被盗的风险和团队的道德风险。

#### 租赁合约

资源租赁合约主要是进行租赁费用的收取以及利润的分配，相对而言是比较不容易出问题的一个业务模块。主要的工作在于把费用和利润计算清楚，保障储户的利益不受损失。

### 总结

总体而言，EOS DApp的安全问题需要从整体的架构设计出发，尽可能隔离各业务模块间的安全问题，并在模块内尽所有可能将其解决好。EOS的合约可迭代升级我们认为是区块链DApp开发的一个重大突破，为DApp的进一步发展提供了基础，同时也因为EOS的合约可迭代导致部分团队不再像ETH上那样重视合约相关的安全工作。我们自己也是在开发了十来款DApp后，才敢分享一些我们自己对于EOS上的合约安全设计的理解，整个DApp生态的安全还是需要更多专业团队的参与和分享。想要了解和学习EOS DApp开发相关知识的，推荐一下我们自己的Github地址：https://github.com/Dappub 上面我们开源了很多合约项目，欢迎大家一起讨论学习。